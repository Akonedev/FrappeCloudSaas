name: Press SaaS Platform - Tests

on:
  push:
    branches: [ main, develop, 001-*, 002-* ]
  pull_request:
    branches: [ main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Install Podman
      run: |
        sudo apt-get update
        sudo apt-get install -y podman

    - name: Create network
      run: podman network create fcs-press-network || true

    - name: Start services
      run: |
        podman compose \
          -f compose.yaml \
          -f overrides/compose.postgres.yaml \
          -f overrides/compose.redis.yaml \
          -f overrides/compose.noproxy.yaml \
          -f overrides/compose.networks.yaml \
          up -d

    - name: Wait for services to be ready
      run: sleep 120

    - name: Create Frappe site
      run: |
        podman exec frappe_docker_git-backend-1 bench new-site press.localhost \
          --admin-password admin \
          --db-type postgres \
          --db-host fcs-press-db \
          --db-port 5432 \
          --db-root-username postgres \
          --db-root-password fcs_press_secure_password_2025 \
          --install-app erpnext \
          --set-default

    - name: Run integration tests
      run: python3 tests/integration/test_services.py
      continue-on-error: true

    - name: Run E2E tests
      run: python3 tests/e2e/test_http_access.py
      continue-on-error: true

    - name: Run security tests
      run: python3 tests/security/test_security.py
      continue-on-error: true

    - name: Run performance tests
      run: python3 tests/performance/test_performance.py
      continue-on-error: true

    - name: Show container logs on failure
      if: failure()
      run: |
        echo "=== Frontend logs ==="
        podman logs fcs-press-frontend || true
        echo "=== Backend logs ==="
        podman logs frappe_docker_git-backend-1 || true
        echo "=== PostgreSQL logs ==="
        podman logs fcs-press-db || true

    - name: Cleanup
      if: always()
      run: |
        podman compose \
          -f compose.yaml \
          -f overrides/compose.postgres.yaml \
          -f overrides/compose.redis.yaml \
          -f overrides/compose.noproxy.yaml \
          -f overrides/compose.networks.yaml \
          down -v || true
