name: Integration Live Tests

on:
  push:
    branches: [ '**' ]
  pull_request:
    branches: [ '**' ]

jobs:
  compose-integration:
    runs-on: ubuntu-latest
    services:
      docker:
        image: docker:24.0.5
        options: --privileged

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & start compose stack
        run: |
          docker compose -f docker/compose.yaml up -d --build

      - name: Wait for Postgres and services
        env:
          PGHOST: 127.0.0.1
          PGPORT: 48532
        run: |
          set -euo pipefail
          # wait for postgres port
            python - <<'PY'
            import socket, time, sys
            host='127.0.0.1'; port=48532
            timeout=120; start=time.time()
            while time.time()-start<timeout:
              try:
                s=socket.create_connection((host, port), timeout=1); s.close(); print('postgres reachable'); sys.exit(0)
              except Exception:
                time.sleep(1)
            print('postgres not reachable', file=sys.stderr); sys.exit(2)
            PY

      - name: Wait for MinIO
        run: |
          python - <<'PY'
          import socket, time, sys
          host='127.0.0.1'; port=48590
          timeout=120; start=time.time()
          while time.time()-start<timeout:
            try:
              s=socket.create_connection((host, port), timeout=1); s.close(); print('minio reachable'); sys.exit(0)
            except Exception:
              time.sleep(1)
          print('minio not reachable', file=sys.stderr); sys.exit(2)
          PY

      - name: Wait for bench (site-runner)
        run: |
          python - <<'PY'
          import socket, time, sys
          host='127.0.0.1'; port=48600
          timeout=120; start=time.time()
          while time.time()-start<timeout:
            try:
              s=socket.create_connection((host, port), timeout=1); s.close(); print('bench reachable'); sys.exit(0)
            except Exception:
              time.sleep(1)
          print('bench not reachable', file=sys.stderr); sys.exit(2)
          PY

      - name: Wait for manager HTTP health
        run: |
          python - <<'PY'
          import time, sys, requests
          url='http://127.0.0.1:48550/health'
          timeout=120; start=time.time()
          while time.time()-start<timeout:
            try:
              r = requests.get(url, timeout=3)
              if r.status_code == 200:
                js = r.json()
                if js.get('status') == 'ok':
                  print('manager healthy'); sys.exit(0)
            except Exception:
              pass
            time.sleep(1)
          print('manager not healthy', file=sys.stderr); sys.exit(2)
          PY

      - name: Install test deps
        run: |
          python -m pip install --upgrade pip
          pip install pytest requests psycopg2-binary boto3 botocore

      - name: Run integration & e2e tests
        env:
          POSTGRES_HOST: 127.0.0.1
          POSTGRES_PORT: 48532
          POSTGRES_USER: press
          POSTGRES_PASSWORD: changeme
          POSTGRES_DB: press
          MINIO_ROOT_USER: minio
          MINIO_ROOT_PASSWORD: minio123
          RECREATE_MINIO: ${RECREATE_MINIO:-'false'}
          USE_REAL_PGDUMP: ${USE_REAL_PGDUMP:-'false'}
        run: |
          # Optionally recreate MinIO volumes before running tests (set RECREATE_MINIO=true)
          if [ "${RECREATE_MINIO:-false}" = 'true' ]; then
            echo "RECREATE_MINIO=true detected â€” removing MinIO volumes (non-interactive)"
            python -c "from scripts.lib.recreate_minio import recreate_minio; recreate_minio(confirm=True, non_interactive=True); print('minio volumes removed')"
          fi
          pytest -q tests/integration/test_schema_manager_live.py -q || ( docker compose -f docker/compose.yaml logs --no-color && false)
          pytest -q tests/integration/test_minio_live.py -q || ( docker compose -f docker/compose.yaml logs --no-color && false)
          pytest -q tests/integration/test_provision_live.py -q || ( docker compose -f docker/compose.yaml logs --no-color && false)
          pytest -q tests/integration/test_backup_restore_live.py -q || ( docker compose -f docker/compose.yaml logs --no-color && false)
          pytest -q tests/e2e/test_site_live.py -q || ( docker compose -f docker/compose.yaml logs --no-color && false)

      - name: Tear down
        if: always()
        run: |
          docker compose -f docker/compose.yaml down --volumes --remove-orphans
