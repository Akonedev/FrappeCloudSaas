# ============================================
# Lago Billing - Docker Compose Override
# ============================================
# Ajouter à la stack principale avec:
# podman-compose -f docker-compose.yml -f docker-compose.lago.yml up -d
# ============================================
# Ports utilisés: 30090-30095
# ============================================

name: frappe-cloud-dev

services:
  # ==========================================
  # LAGO - PostgreSQL Database
  # ==========================================
  lago-db:
    image: docker.io/postgres:16-alpine
    container_name: lago-db
    restart: unless-stopped
    environment:
      POSTGRES_USER: lago
      POSTGRES_PASSWORD: ${LAGO_DB_PASSWORD:-lago_secret_2024}
      POSTGRES_DB: lago
      PGDATA: /var/lib/postgresql/data/pgdata
    volumes:
      - lago-postgres-data:/var/lib/postgresql/data
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U lago -d lago"]
      interval: 10s
      timeout: 5s
      retries: 10
      start_period: 30s

  # ==========================================
  # LAGO - Redis Cache
  # ==========================================
  lago-redis:
    image: docker.io/redis:7.4-alpine
    container_name: lago-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - lago-redis-data:/data
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 5s
      timeout: 3s
      retries: 5

  # ==========================================
  # LAGO - API Backend
  # ==========================================
  lago-api:
    image: docker.io/getlago/api:v1.20.1
    container_name: lago-api
    restart: unless-stopped
    environment:
      # Database
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-lago_secret_2024}@lago-db:5432/lago
      REDIS_URL: redis://lago-redis:6379
      
      # Rails
      RAILS_ENV: production
      RAILS_LOG_TO_STDOUT: "true"
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-$(openssl rand -hex 64)}
      ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_KEY:-$(openssl rand -hex 32)}
      ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_DET_KEY:-$(openssl rand -hex 32)}
      ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_SALT:-$(openssl rand -hex 32)}
      
      # API Configuration
      LAGO_API_URL: http://lago-api:3000
      LAGO_FRONT_URL: ${LAGO_FRONT_URL:-http://billing.localhost:30091}
      
      # RSA Keys (générer avec: openssl genrsa 2048 | base64 -w 0)
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      
      # License (laisser vide pour Community Edition)
      LAGO_LICENSE: ""
      
      # Disable premium features
      LAGO_CLOUD: "false"
    depends_on:
      lago-db:
        condition: service_healthy
      lago-redis:
        condition: service_healthy
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:3000/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # ==========================================
  # LAGO - Background Workers
  # ==========================================
  lago-worker:
    image: docker.io/getlago/api:v1.20.1
    container_name: lago-worker
    restart: unless-stopped
    command: ["bundle", "exec", "sidekiq", "-C", "config/sidekiq.yml"]
    environment:
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-lago_secret_2024}@lago-db:5432/lago
      REDIS_URL: redis://lago-redis:6379
      RAILS_ENV: production
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-$(openssl rand -hex 64)}
      ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_KEY:-$(openssl rand -hex 32)}
      ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_DET_KEY:-$(openssl rand -hex 32)}
      ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_SALT:-$(openssl rand -hex 32)}
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      LAGO_LICENSE: ""
      LAGO_CLOUD: "false"
    depends_on:
      lago-api:
        condition: service_healthy
    networks:
      - backend

  # ==========================================
  # LAGO - Clock (Scheduled Jobs)
  # ==========================================
  lago-clock:
    image: docker.io/getlago/api:v1.20.1
    container_name: lago-clock
    restart: unless-stopped
    command: ["bundle", "exec", "clockwork", "config/clock.rb"]
    environment:
      DATABASE_URL: postgresql://lago:${LAGO_DB_PASSWORD:-lago_secret_2024}@lago-db:5432/lago
      REDIS_URL: redis://lago-redis:6379
      RAILS_ENV: production
      SECRET_KEY_BASE: ${LAGO_SECRET_KEY:-$(openssl rand -hex 64)}
      ENCRYPTION_PRIMARY_KEY: ${LAGO_ENCRYPTION_KEY:-$(openssl rand -hex 32)}
      ENCRYPTION_DETERMINISTIC_KEY: ${LAGO_DET_KEY:-$(openssl rand -hex 32)}
      ENCRYPTION_KEY_DERIVATION_SALT: ${LAGO_SALT:-$(openssl rand -hex 32)}
      LAGO_RSA_PRIVATE_KEY: ${LAGO_RSA_PRIVATE_KEY:-}
      LAGO_LICENSE: ""
      LAGO_CLOUD: "false"
    depends_on:
      lago-api:
        condition: service_healthy
    networks:
      - backend

  # ==========================================
  # LAGO - Frontend
  # ==========================================
  lago-frontend:
    image: docker.io/getlago/front:v1.20.1
    container_name: lago-frontend
    restart: unless-stopped
    environment:
      API_URL: http://lago-api:3000
      APP_ENV: production
      LAGO_DISABLE_SIGNUP: "false"
      LAGO_OAUTH_GOOGLE_CLIENT_ID: ""
    depends_on:
      lago-api:
        condition: service_healthy
    networks:
      - frontend
      - backend

volumes:
  lago-postgres-data:
  lago-redis-data:
