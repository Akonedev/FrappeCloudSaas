# ============================================================
# TRAEFIK - Configuration Dynamique (File Provider)
# ============================================================
# Services: fcs-frappe-backend, fcs-lago-api, fcs-lago-frontend
# ============================================================

http:
  routers:
    # ==========================================================
    # PRESS / FRAPPE - Dashboard principal
    # ==========================================================
    fcs-press-router:
      rule: "Host(`press.localhost`) || Host(`cloud.localhost`)"
      entryPoints:
        - web
      service: fcs-frappe-backend-svc
      priority: 100

    fcs-frappe-api-router:
      rule: "Host(`press.localhost`) && PathPrefix(`/api`)"
      entryPoints:
        - web
      service: fcs-frappe-backend-svc
      priority: 200

    # ==========================================================
    # LAGO - Billing Dashboard
    # ==========================================================
    fcs-lago-frontend-router:
      rule: "Host(`billing.localhost`)"
      entryPoints:
        - web
      service: fcs-lago-frontend-svc
      priority: 100

    fcs-lago-api-router:
      rule: "Host(`api.billing.localhost`) || (Host(`billing.localhost`) && PathPrefix(`/api`))"
      entryPoints:
        - web
      service: fcs-lago-api-svc
      priority: 200

    # ==========================================================
    # MINIO - Storage Console
    # ==========================================================
    fcs-minio-console-router:
      rule: "Host(`storage.localhost`)"
      entryPoints:
        - web
      service: fcs-minio-console-svc
      priority: 100

    # ==========================================================
    # KEYCLOAK - SSO Authentication
    # ==========================================================
    fcs-keycloak-router:
      rule: "Host(`auth.localhost`)"
      entryPoints:
        - web
      service: fcs-keycloak-svc
      priority: 100

    # ==========================================================
    # LAGO OAuth Proxy - SSO via Keycloak
    # ==========================================================
    fcs-lago-oauth-router:
      rule: "Host(`oauth.billing.localhost`)"
      entryPoints:
        - web
      service: fcs-lago-oauth-svc
      priority: 100

  services:
    # Press/Frappe Backend
    fcs-frappe-backend-svc:
      loadBalancer:
        servers:
          - url: "http://fcs-frappe-backend:8000"
        healthCheck:
          path: "/api/method/ping"
          interval: "30s"
          timeout: "10s"

    # Lago Frontend
    fcs-lago-frontend-svc:
      loadBalancer:
        servers:
          - url: "http://fcs-lago-frontend:80"

    # Lago API
    fcs-lago-api-svc:
      loadBalancer:
        servers:
          - url: "http://fcs-lago-api:3000"
        healthCheck:
          path: "/health"
          interval: "30s"
          timeout: "10s"

    # MinIO Console
    fcs-minio-console-svc:
      loadBalancer:
        servers:
          - url: "http://fcs-minio:9001"

    # Keycloak SSO
    fcs-keycloak-svc:
      loadBalancer:
        servers:
          - url: "http://fcs-keycloak:8080"

    # Lago OAuth Proxy
    fcs-lago-oauth-svc:
      loadBalancer:
        servers:
          - url: "http://fcs-lago-oauth-proxy:4180"
